import{c as e,d as t,h as n,l as r,m as i,n as a,o,p as s,s as c,t as l,u}from"./nix-D8-yUCuv.js";async function d(){if(r(`state`)!==`ok`){u(`Did not successfully initialize, skipping push`);return}u(`Collecting packages`);let s=new Set(JSON.parse(r(`packages`))),d=await a(),f=new Set;for(let[e,t]of d)t.ultimate&&(s.has(e)||f.add(`${t.storeDir}/${e}`));if(f.size===0){u(`No new packages to push`);return}let p=e(`server-url`,{required:!1}),m=e(`auth-token`,{required:!1}),h=e(`audience`,{required:!1}),g=e(`max-concurrent-uploads`,{required:!1}),_=e(`verify-s3-integrity`,{required:!1});i(`Pushing ${f.size} packages to cache...`);for(let e of f){let r=[`push`];if(p&&m)r.push(`--server-url`,p,`--auth-token`,m);else if(h)r.push(`--server-url`,h,`--auth-token`,await c(h));else throw Error(`Either server-url and auth-token or audience must be provided`);g&&r.push(`--max-concurrent-uploads`,g),_.toLowerCase()===`true`&&r.push(`--verify-s3-integrity`),r.push(e),u(e),u(l(e)),await n(`niks3`,r,{ignoreReturnCode:!0,silent:!t()})}o()}try{await d()}catch(e){e instanceof Error&&s(e.message)}export{};