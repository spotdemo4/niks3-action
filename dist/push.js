import{a as e,c as t,f as n,l as r,m as i,o as a,p as o,s,t as c}from"./nix-CJu3pCAs.js";async function l(){if(t(`state`)!==`ok`){r(`Did not successfully initialize, skipping push`);return}r(`Collecting packages`);let n=new Set(JSON.parse(t(`packages`))),l=await c();r(`Filtering packages`);let u=new Set;for(let[e,t]of l)t.ultimate&&(n.has(e)||u.add(`${t.storeDir}/${e}`));if(u.size===0){r(`No new packages to push`);return}let d=s(`server-url`,{required:!1}),f=s(`auth-token`,{required:!1}),p=s(`audience`,{required:!1}),m=s(`max-concurrent-uploads`,{required:!1});o(`Pushing ${u.size} packages to cache`);for(let e of u)p&&(d=p,f=await a(p)),await i(`niks3`,[`push`,`--server-url`,d,`--auth-token`,f,`--max-concurrent-uploads`,m||`30`,e],{ignoreReturnCode:!0});e()}try{await l()}catch(e){e instanceof Error&&n(e.message)}export{};