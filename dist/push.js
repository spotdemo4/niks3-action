import{a as e,c as t,f as n,l as r,m as i,o as a,p as o,s,t as c,u as l}from"./nix-CJu3pCAs.js";async function u(){if(t(`state`)!==`ok`){r(`Did not successfully initialize, skipping push`);return}r(`Collecting packages`);let n=new Set(JSON.parse(t(`packages`))),u=await c(),d=new Set;for(let[e,t]of u)t.ultimate&&(n.has(e)||d.add(`${t.storeDir}/${e}`));if(d.size===0){r(`No new packages to push`);return}let f=s(`server-url`,{required:!1}),p=s(`auth-token`,{required:!1}),m=s(`audience`,{required:!1}),h=s(`max-concurrent-uploads`,{required:!1}),g=s(`verify-s3-integrity`,{required:!1});o(`Pushing ${d.size} packages to cache...`);for(let e of d){let t=[`push`];if(f&&p)t.push(`--server-url`,f,`--auth-token`,p);else if(m)t.push(`--server-url`,m,`--auth-token`,await a(m));else throw Error(`Either server-url and auth-token or audience must be provided`);h&&t.push(`--max-concurrent-uploads`,h),g.toLowerCase()===`true`&&t.push(`--verify-s3-integrity`),t.push(e),r(e),await i(`niks3`,t,{ignoreReturnCode:!0,silent:!l()})}e()}try{await u()}catch(e){e instanceof Error&&n(e.message)}export{};