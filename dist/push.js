import{_ as e,c as t,d as n,f as r,g as i,h as a,i as o,l as s,m as c,n as l,s as u,t as d,u as f}from"./nix-CwHGG-W2.js";const p=new o({level:2});async function m(){if(f(`state`)!==`ok`){n(p.red(`Did not successfully initialize, skipping push`));return}n(`Collecting packages`);let o=new Set(JSON.parse(f(`packages`))),c=await l(),m=new Set;for(let[e,t]of c)t.ultimate&&(o.has(e)||m.add(`${t.storeDir}/${e}`));if(m.size===0){n(p.green(`No new packages to push`));return}let h=s(`server-url`,{required:!1}),g=s(`auth-token`,{required:!1}),_=s(`audience`,{required:!1}),v=s(`max-concurrent-uploads`,{required:!1}),y=s(`verify-s3-integrity`,{required:!1});n(p.cyan(`Pushing ${p.bold(m.size)} packages to cache`));for(let n of m){let o=[`push`];if(h&&g)o.push(`--server-url`,h,`--auth-token`,g);else if(_)o.push(`--server-url`,_,`--auth-token`,await t(_));else throw Error(`Either server-url and auth-token or audience must be provided`);v&&o.push(`--max-concurrent-uploads`,v),y.toLowerCase()===`true`&&o.push(`--verify-s3-integrity`),r()&&o.push(`--debug`),o.push(n),a(d(n)),await e(`niks3`,o,{ignoreReturnCode:!0})!==0&&i(`niks3 push failed for ${n}`),u()}}try{await m()}catch(e){e instanceof Error&&c(e.message)}export{};